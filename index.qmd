---
title: Dashboard
format: 
  dashboard:
    scrolling: true
  html:
    page-layout: custom
execute: 
  echo: false
---

<!-- Setup, no output -->

```{r setup, include=FALSE}
## Packages
pacman::p_load(here, 
               purrr, readr, dplyr,
               bslib, bsicons, 
               ggplot2)
## Load all csv data
data <- list.files(here("data"), pattern = "*.csv")
names(data) <- gsub("\\.csv", "", data)
data <- map(data,
            ~ read_csv(here("data", .x)) |> 
              mutate(Group = ifelse(is.na(Group), "Overall", Group)))

## Source plotting scripts
source(here("R", "plot_bmicategory_proportions.R"))
source(here("R", "plot_bmicategory_proportions_time_series.R"))
source(here("R", "plot_current_summary_stats.R"))
source(here("R", "plot_time_series_statistics.R"))

## Set parameters
params <- list(
  # Most recent date
  latest_date = max(data$time_series_table$Date),
  # N
  participants = data$bmicategory_proportions |> 
    filter(Date == max(Date) & Stratification=="Overall") |> 
                 pull(n) |> sum(),
  # Overall median
  median_change = data$current_summary_stats |> 
    filter(Stratification=="Overall" & 
             Variable=="% Weight Change from Prewar Value") |> 
    pull(median) |> round(digits = 1),
  # Stratifications
  strata = unique(data$bmicategory_proportions$Stratification)
  )
```

<!-- Global sidebar -->

# {.sidebar}

::: {.callout-tip}

## Latest data

As of **`r params$latest_date`**:

- **`r params$participants`** participants
- Median **`r params$median_change`**kg change from pre-war weight

:::

### 

This project aims to monitor the nutritional status of humanitarian aid staff currently working in Gaza by tracking their weight. 
The aim of this project is to inform humanitarian decision-making, advocacy and diplomatic action to improve the lives of the affected population by providing real-time information on the nutritional status of humanitarian staff in Gaza. 

::: {.callout-note collapse="true"}

## Study information

The project is implemented by SCI with the support of the London School of Hygiene and Tropical Medicine (LSHTM).
All participation is entirely voluntary.

Staff from the following organisations are currently contributing data:

```{r contributing-orgs, results='asis'}
# org_list <- paste0("\n- ", sort(params$org))
# cat(org_list)
```

Find out more:

- [Study protocol](./protocol)
- [Contributors and contact](./about)

:::

<!-- Dashboard page 1 -->

# Weight change

## Row

### Column

::: {.card title="Change from pre-war baseline"}

::: {.panel-tabset}

```{r plot-baseline-weight, results="asis"}
for(i in params$strata) {
  cat(glue::glue("#### {i} \n\n"))
  cat("\n \n")
  print(
    plot_current_summary_stats(
      data = data$current_summary_stats,
      strata = i
    )
  )
  cat(' \n \n')
}
```

:::

:::

### Column

::: {.card title="Trend over time"}

::: {.panel-tabset}

```{r plot-trends-weight, results="asis"}
for(i in params$strata) {
  cat(glue::glue("### {i} \n\n"))
  cat("\n \n")
  print(
    plot_time_series_statistics(
      data = data$time_series_table,
      strata = i
    )
  )
  cat(' \n \n')
}
```

:::

:::

## Row {height=20%}

::: {.card title="Notes"}

Change in self-reported weight from pre-war baseline.

:::

<!-- Dashboard page 2 -->

# BMI change

## Row

### Column

::: {.card title="Change from pre-war baseline"}

::: {.panel-tabset}

```{r plot-baseline-bmi, results="asis"}
for(i in params$strata) {
  cat(glue::glue("#### {i} \n\n"))
  cat("\n \n")
  
  print(
    plot_bmicategory_proportions(
      data = data$bmicategory_proportions,
      strata = i
    )
  )
  cat(' \n \n')
}
```

:::

:::

### Column

::: {.card title="Trend over time"}

::: {.panel-tabset}

```{r plot-trends-bmi, results="asis"}
for(i in params$strata) {
  cat(glue::glue("### {i} \n\n"))
  cat("\n \n")
  print(
    plot_bmicategory_proportions_time_series(
      data = data$bmicategory_proportions,
      strata = i
    )
  )
  cat(' \n \n')
}
```

:::

:::

## Row {height=20%}

::: {.card title="Notes"}

Proportion of staff with BMI in different WHO categories: underweight <18.5, normal 18.50 – 24.99, overweight ≥ 25, obese ≥ 30.

:::

<!-- Dashboard page 3 -->

# Modelled % change 

::: {.card title = "Modelled change in individual weight"}

::: {.panel-tabset}

```{r plot-gam, results="asis"}
for(i  in params$strata) {
  cat(glue::glue("### {i} \n\n"))
  cat("\n \n")
  print(
    ""
  )
  cat(' \n \n')
}
```

:::

::: {.card title="Notes"}

Modelled changes in self-reported weight.

:::

:::
