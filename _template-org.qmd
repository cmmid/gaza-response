---
title: Dashboard
format: 
  dashboard:
    orientation: rows
    scrolling: true
    include-in-header:
      text: |
            <script src="lshtm.js"></script>
    css: "styles.css"
    fig-format: svg
toc: false
execute: 
  echo: false
  cache: true
---

```{r, include=FALSE}
pacman::p_load(here, 
               purrr, readr, dplyr, forcats, stringr,
               bslib, bsicons, 
               ggplot2, plotly, shiny, patchwork)
data_filtered <- data[[meta_params$organisation]]
# split data into current 72h summary, or full timeseries
data_filtered_current <- map(data_filtered,
                             ~ filter(.x, !is.na(current_summary_date)) |> 
                               mutate(date = current_summary_date))
data_filtered_timeseries <- map(data_filtered,
                             ~ filter(.x, !is.na(date)))

params <- generate_key_insights(data_filtered_current, strata = "overall")
params$cohort_ever_enrolled <- max(data_filtered$overall$cohort_id_enrolled,
                                   na.rm = TRUE)
```

## ROW {.tabset}

### Key insights

::: {.card}
- Data updated as of **`r params$latest_date`**
- Recent data from **`r params$cohort_size` participants** (latest 72 hours), with `r params$cohort_ever_enrolled` ever enrolled in the study
- From **October 2023 to now**, recent participants experienced **`r params$median_change`% (`r params$lower_change`% to `r params$upper_change`%) weight change** (median, 25-75% range)
:::

::: {.card .current_summary_card .lshtm_widget title="Key insights" fill="false"}
<div class="lshtm_widget_identifier" id="current_summary">
```{r, results="asis"}
#| fig-align: center
for(i in strata) {
  # show the first stratum (overall) by default
  visible_class = ifelse(i == strata[1], "visible", "")
  cat(glue::glue("<div class='lshtm_widget_content {visible_class}' id='current_summary_{i}'>"))
  print(
    plot_current_summary_stats(
      data = data_filtered_current,
      strata = i
    )
  )
  cat('</div>')
}
```
</div>
::: {.callout-note collapse="true" title="Data" appearance="simple"}
Median and 25-75% range of participant weight in kilograms (kg) and [Body Mass Index](https://www.cdc.gov/bmi/adult-calculator/index.html?), with % change from pre-October 2023. Negative % indicate weight loss.
:::
:::

```{r}
#| title: "Participant BMI"
log$tab_participants$bmi_crosstab
```


### Participation

::: {.card .participants_card .lshtm_widget title="Participants" fill="false"}
<div class="lshtm_widget_identifier" id="participants">
```{r, results="asis"}
#| fig-align: center
for(i in strata) {
  visible_class = ifelse(i == strata[1], "visible", "")
  cat(glue::glue("<div class='lshtm_widget_content {visible_class}' id='participants_{i}'>"))
  print(
    plot_participants_over_time(
      data = data_filtered_timeseries,
      strata = i
    )
  )
  cat('</div>')
}
```
</div>
::: {.callout-note collapse="true" title="Data" appearance="simple"}
Daily data availability, showing:
- Measurements contributed by newly recruited participants ("New")
- Measurements from previously enrolled participants ("Repeated")
- Previously enrolled participants without recent^[Last 72 hours] data ("Lost to follow up")
:::
:::

```{r}
#| title: "Characteristics"
knitr::knit_print(log$log_tab)
```

```{r}
#| title: "Data quality"
log$factor_count |> 
  mutate(p = round(p*100, digits=0)) |> 
  filter(f %in% c("Missing", "anomaly")) |> 
  mutate(f = stringr::str_to_sentence(f),
         variable = stringr::str_to_sentence(variable),
         variable = case_when(variable == "Agegroup"~ "Age",
                              variable == "Children_feeding"~"Dependent children",
                              variable == "Bmi_category_daily"~"BMI category, current",
                              variable == "Bmi_category_prewar"~
                                "BMI category, autumn 2023",
                              variable == "Weight_anomaly"~"Weight",
                              TRUE~variable)) |> 
  rename("Group" = variable, 
         "Participant record status" = f, 
         "Count" = n, 
         "% all records" = p) |> 
  kableExtra::kable() |> 
  kableExtra::add_footnote("Valid ranges: weight, 30-180kg; BMI, 10-60; age, 16-99 years; dependent children, 0-20")
```

## COL {.tabset}

### Weight change

::: {.card .weight_trend_card .lshtm_widget fill="false"}
<div class="lshtm_widget_identifier" id="weight_trend">
```{r, results="asis"}
#| fig-align: center
for(i in strata) {
  visible_class = ifelse(i == strata[1], "visible", "")
  cat(glue::glue("<div class='lshtm_widget_content {visible_class}' id='weight_trend_{i}'>"))
  print(
   plot_time_series_statistics(
      data = data_filtered_timeseries,
      summary_variable = "weight",
      strata = i
    ) +
  plot_time_series_statistics(
      data = data_filtered_timeseries,
      summary_variable = "weight_percent_change_prewar",
      strata = i
    ) +
     plot_layout(ncol = 2)
  )
  cat('</div>')
}
```
</div>
::: {.callout-note collapse="true" title="Data" appearance="simple"}
Trends over time in participant current measurements, with comparison to pre-war levels (% change since October 2023), since the beginning of the project.
:::
:::

### BMI change

::: {.card .bmi_trend_card .lshtm_widget fill="false"}
<div class="lshtm_widget_identifier" id="bmi_trend">
```{r, results="asis"}
#| fig-align: center
for(i in strata) {
  visible_class = ifelse(i == strata[1], "visible", "")
  cat(glue::glue("<div class='lshtm_widget_content {visible_class}' id='bmi_trend_{i}'>"))
  print(
   plot_time_series_statistics(
      data = data_filtered_timeseries,
      summary_variable = "bmi",
      strata = i
    ) +
  plot_time_series_statistics(
      data = data_filtered_timeseries,
      summary_variable = "bmi_percent_change_prewar",
      strata = i
    ) +
     plot_layout(ncol = 2)
  )
  cat('</div>')
}
```
</div>
::: {.callout-note collapse="true" title="Data" appearance="simple"}
Trends over time in participant current measurements, with comparison to pre-war levels (% change since October 2023), since the beginning of the project.
:::
:::

### BMI category

::: {.card .bmi_cat_card .lshtm_widget fill="false"}
<div class="lshtm_widget_identifier" id="bmi_cat">
```{r, results="asis"}
#| fig-align: center
for(i in strata) {
  # show the first stratum (overall) by default
  visible_class = ifelse(i == strata[1], "visible", "")
  cat(glue::glue("<div class='lshtm_widget_content {visible_class}' id='bmi_cat_{i}'>"))
  print(
     plot_bmicategory_proportions_time_series(
     data = data_filtered_timeseries,
     strata = i
    )
  )
  cat('</div>')
}
```
</div>
::: {.callout-note collapse="true" title="Data" appearance="simple"}
Trends over time of proportion of staff with BMI in different [WHO categories](https://www.who.int/data/gho/data/themes/topics/topic-details/GHO/body-mass-index): underweight <18.5, normal 18.50 – 24.99, overweight ≥ 25, obese ≥ 30. Calculated as the number of measurements per week that fall in each category, divided by the total number of measurements that week ("N").
:::
:::
