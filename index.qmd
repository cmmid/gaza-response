---
title: Dashboard
format: 
  dashboard:
    scrolling: true
    include-in-header:
      text: |
            <script src="lshtm.js"></script>
    css: "styles.css"
    fig-format: svg
  #html:
  #  page-layout: custom
toc: true
execute: 
  echo: false
---

<!-- Setup, no output -->

```{r setup, include=FALSE}
## Packages
pacman::p_load(here, 
               purrr, readr, dplyr,
               bslib, bsicons, 
               ggplot2, plotly)

## Load data dictionary
datadict <- readRDS("data/data_dictionary.RDS")

## Load Data RDS
data <- readRDS("data/public/summary-stats.RDS")

options <- c("sex", "agegroup", "governorate", "role")
# Generate all non-empty combinations
strata <- unlist(
  #lapply(1:length(options), function(k) {
  lapply(1:2, function(k) {
    combn(sort(options), k, FUN = function(x) paste(x, collapse = "-"))
  })
)
# Add 'Overall' as default/fallback
strata <- c("Overall", strata)

organisations <- names(data)[2:length(data)]

## Source plotting scripts
source(here("R", "data-analysis/generate_key_insights.R"))
source(here("R", "data-analysis/recode_data_table.R"))
source(here("R", "data-analysis/plot_participants_over_time.R"))
source(here("R", "data-analysis/plot_current_summary_stats.R"))
source(here("R", "data-analysis/plot_time_series_statistics.R"))
source(here("R", "data-analysis/plot_bmicategory_proportions_time_series.R"))
source(here("R", "data-analysis/ggplot_theme.R"))

```

<!-- Global sidebar -->

# {.sidebar}

This project provides real-time information on the nutritional status of humanitarian staff in Gaza. Our aim is to inform humanitarian decision-making, advocacy, and diplomatic action to improve the lives of the affected population. We are developing this project during a rapidly changing situation: please interpret results with caution. [Find out more](./about)

::: {.callout-caution title="Join us"}
We are actively seeking participants to support the project, and welcome new collaborations with humanitarian organisations. [**Get involved**](./contact)
:::

<!-- Add data filter
 - todo: change to pandoc format
 - todo: fill options automatically or wrap in function
-->
<div class="lshtm_widget_filter">
  <p><strong>Stratify data by</strong></p>
  <div class="filter_content">
  <fieldset>
    <!--<legend>Stratify data by</legend>-->
    <label>
      <input type="checkbox" name="data_filter" value="sex">
      Sex
    </label><br>
    <label>
      <input type="checkbox" name="data_filter" value="agegroup">
      Age
    </label><br>
    <label>
      <input type="checkbox" name="data_filter" value="governorate">
      Location
    </label><br>
    <label>
      <input type="checkbox" name="data_filter" value="role">
      Role
    </label>
  </fieldset>
</div>
</div>

<!-- Dashboard page 1 -->


# All Participants

```{r filter_all, include=FALSE}
data_filtered <- filter(data, organisation == "all")
# split data into current 72h summary, or full timeseries
# Hi I am commenting this out because it doesn't match the data structure
# This code is written with the indication that a change was introduced to the data analysis pipeline that gets the
# 72 hour summary and puts it into the spreadsheet as date = NA
data_filtered_current <- filter(data_filtered, date == max(date, na.rm=TRUE)) # Temporary fix bc the data from the pipeline isnt' matching atm
data_filtered_timeseries <- filter(data_filtered, !is.na(date))

params <- generate_key_insights(data_filtered_current, strata = "Overall") # TODO iterate over strata to match other chunks
```

## Row

::: {.card fill="false" title="Key insights"}
- Data updated as of **`r params$latest_date`**
<!--- Data from **`r params$cohort_size` participants** reporting over the last 72 hours
commenting out, because there's a bug here somewhere at least -->
- Median change of **`r params$median_change`%** compared to pre-war weight (with a typical range of `r params$lower_change`% to `r params$upper_change`%)
:::

## Row

::: {.card .current_summary_card .lshtm_widget title="Current summary" fill = "false"}
<!-- Can't set ID or data-widget value in this pandoc-card element, so need another nested div... -->
<div class="lshtm_widget_identifier" id="current_summary">
```{r plot-current-summary, results="asis"}
#| fig-width: 8
#| fig-asp: 0.4
#| fig-align: center
for(i in strata) {
  # show the first stratum (overall) by default
  visible_class = ifelse(i == strata[1], "visible", "")
  cat(glue::glue("<div class='lshtm_widget_content {visible_class}' id='current_summary_{i}'>"))
  
  print(
    plot_current_summary_stats(
      data = data_filtered_current,
      strata = i
    )
  )
  cat('</div>')
}
```
</div>
Summary of most recent data provided by participants reporting over the last 3 days. Current weight in kilograms (kg) and [BMI (body mass index)](https://www.cdc.gov/bmi/adult-calculator/index.html?), in addition to percent change in weight and BMI from pre-war levels (before October 8th 2023) are shown on the x-axes of the panels. Negative values of percent change indicate weight loss, i.e. '-20%' indicates an average loss of 20% of weight or BMI.
:::

## Row
<!-- Create div for trend over time -->
::: {.card .trend_time_card .lshtm_widget title="Recent trends" fill = "false"}
<!-- Can't set ID or data-widget value in this pandoc-card element, so need another nested div... -->
<div class="lshtm_widget_identifier" id="trend_over_time">
```{r plot-trends-weight, results="asis"}
#| fig-width: 8
#| fig-asp: 1.3
#| fig-align: center
for(i in strata) {
  # show the first stratum (overall) by default
  visible_class = ifelse(i == strata[1], "visible", "")
  cat(glue::glue("<div class='lshtm_widget_content {visible_class}' id='trend_over_time_{i}'>"))
  
  print(
   plot_time_series_statistics(
      data = data_filtered_timeseries,
      strata = i
    )
  )
  cat('</div>')
}
```
</div>
Trends over time in absolute values of weight in kilograms (kg) and [BMI (body mass index)](https://www.cdc.gov/bmi/adult-calculator/index.html?) and percent change in weight and BMI from pre-war levels (before October 8th 2023) since the beginning of the project. Solid and dashed lines indicate mean and median values respectively for each demographic stratification. The coloured shaded regions show the boundaries of the interquartile range.
:::

## Row
<!-- Create div for trend over time -->
::: {.card .trend_bmi_card .lshtm_widget title="% Participants by BMI category" fill = "false"}
<!-- Can't set ID or data-widget value in this pandoc-card element, so need another nested div... -->
<div class="lshtm_widget_identifier" id="trends_bmi">
```{r plot-trends-bmi, results="asis"}
#| fig-width: 8
#| fig-asp: 1
#| fig-align: center
for(i in strata) {
  # show the first stratum (overall) by default
  visible_class = ifelse(i == strata[1], "visible", "")
  cat(glue::glue("<div class='lshtm_widget_content {visible_class}' id='trends_bmi_{i}'>"))
  
  print(
     plot_bmicategory_proportions_time_series(
     data = data_filtered_timeseries,
     strata = i
    )
  )
  cat('</div>')
}
```
</div>
Trends over time of proportion of staff with BMI in different [WHO categories](https://www.who.int/data/gho/data/themes/topics/topic-details/GHO/body-mass-index): underweight <18.5, normal 18.50 – 24.99, overweight ≥ 25, obese ≥ 30. Calculated as the number of measurements per day that fall in each category, divided by the total number of measurements that day.
:::

## Row

::: {.card fill="false" .lshtm_widget title="Study participation"}
<div class="lshtm_widget_identifier" id="participants_over_time">
```{r plot-participants-over-time, results="asis"}
#| fig-width: 7
#| fig-asp: 0.5
#| fig-align: center
for(i in strata) {
  # show the first stratum (overall) by default
  visible_class = ifelse(i == strata[1], "visible", "")
  cat(glue::glue("<div class='lshtm_widget_content {visible_class}' id='participants_over_time_{i}'>"))
  
  print(
    plot_participants_over_time(
      data = data_filtered_timeseries,
      strata = i
    )
  )
  cat('</div>')
}
```
</div>
:::



<!-- ------------------------ Organisation tabs --------------------------- -->

# Save the Children International

```{r filter_stc, include=FALSE}
data_filtered <- filter(data, organisation == "Save the Children International")
# split data into current 72h summary, or full timeseries
# Hi I am commenting this out because it doesn't match the data structure
# This code is written with the indication that a change was introduced to the data analysis pipeline that gets the
# 72 hour summary and puts it into the spreadsheet as date = NA
data_filtered_current <- filter(data_filtered, date == max(date, na.rm=TRUE)) # Temporary fix bc the data from the pipeline isnt' matching atm
data_filtered_timeseries <- filter(data_filtered, !is.na(date))

params <- generate_key_insights(data_filtered_current, strata = "Overall") # TODO iterate over strata to match other chunks
```

## Row

::: {.card fill="false" title="Key insights"}
- Data updated as of **`r params$latest_date`**
<!--- Data from **`r params$cohort_size` participants** reporting over the last 72 hours
commenting out, because there's a bug here somewhere at least -->
- Median change of **`r params$median_change`%** compared to pre-war weight (with a typical range of `r params$lower_change`% to `r params$upper_change`%)
:::

## Row

::: {.card .current_summary_card .lshtm_widget title="Current summary" fill = "false"}
<!-- Can't set ID or data-widget value in this pandoc-card element, so need another nested div... -->
<div class="lshtm_widget_identifier" id="current_summary">
```{r plot-current-summary-stc, results="asis"}
#| fig-width: 8
#| fig-asp: 0.4
#| fig-align: center
for(i in strata) {
  # show the first stratum (overall) by default
  visible_class = ifelse(i == strata[1], "visible", "")
  cat(glue::glue("<div class='lshtm_widget_content {visible_class}' id='current_summary_{i}'>"))
  
  print(
    plot_current_summary_stats(
      data = data_filtered_current,
      strata = i
    )
  )
  cat('</div>')
}
```
</div>
Summary of most recent data provided by participants reporting over the last 3 days. Current weight in kilograms (kg) and [BMI (body mass index)](https://www.cdc.gov/bmi/adult-calculator/index.html?), in addition to percent change in weight and BMI from pre-war levels (before October 8th 2023) are shown on the x-axes of the panels. Negative values of percent change indicate weight loss, i.e. '-20%' indicates an average loss of 20% of weight or BMI.
:::

## Row
<!-- Create div for trend over time -->
::: {.card .trend_time_card .lshtm_widget title="Recent trends" fill = "false"}
<!-- Can't set ID or data-widget value in this pandoc-card element, so need another nested div... -->
<div class="lshtm_widget_identifier" id="trend_over_time">
```{r plot-trends-weight-stc, results="asis"}
#| fig-width: 8
#| fig-asp: 1.3
#| fig-align: center
for(i in strata) {
  # show the first stratum (overall) by default
  visible_class = ifelse(i == strata[1], "visible", "")
  cat(glue::glue("<div class='lshtm_widget_content {visible_class}' id='trend_over_time_{i}'>"))
  
  print(
   plot_time_series_statistics(
      data = data_filtered_timeseries,
      strata = i
    )
  )
  cat('</div>')
}
```
</div>
Trends over time in absolute values of weight in kilograms (kg) and [BMI (body mass index)](https://www.cdc.gov/bmi/adult-calculator/index.html?) and percent change in weight and BMI from pre-war levels (before October 8th 2023) since the beginning of the project. Solid and dashed lines indicate mean and median values respectively for each demographic stratification. The coloured shaded regions show the boundaries of the interquartile range.
:::

## Row
<!-- Create div for trend over time -->
::: {.card .trend_bmi_card .lshtm_widget title="% Participants by BMI category" fill = "false"}
<!-- Can't set ID or data-widget value in this pandoc-card element, so need another nested div... -->
<div class="lshtm_widget_identifier" id="trends_bmi">
```{r plot-trends-bmi-stc, results="asis"}
#| fig-width: 8
#| fig-asp: 1
#| fig-align: center
for(i in strata) {
  # show the first stratum (overall) by default
  visible_class = ifelse(i == strata[1], "visible", "")
  cat(glue::glue("<div class='lshtm_widget_content {visible_class}' id='trends_bmi_{i}'>"))
  
  print(
     plot_bmicategory_proportions_time_series(
     data = data_filtered_timeseries,
     strata = i
    )
  )
  cat('</div>')
}
```
</div>
Trends over time of proportion of staff with BMI in different [WHO categories](https://www.who.int/data/gho/data/themes/topics/topic-details/GHO/body-mass-index): underweight <18.5, normal 18.50 – 24.99, overweight ≥ 25, obese ≥ 30. Calculated as the number of measurements per day that fall in each category, divided by the total number of measurements that day.
:::

## Row

::: {.card fill="false" .lshtm_widget title="Study participation"}
<div class="lshtm_widget_identifier" id="participants_over_time">
```{r plot-participants-over-time-stc, results="asis"}
#| fig-width: 7
#| fig-asp: 0.5
#| fig-align: center
for(i in strata) {
  # show the first stratum (overall) by default
  visible_class = ifelse(i == strata[1], "visible", "")
  cat(glue::glue("<div class='lshtm_widget_content {visible_class}' id='participants_over_time_{i}'>"))
  
  print(
    plot_participants_over_time(
      data = data_filtered_timeseries,
      strata = i
    )
  )
  cat('</div>')
}
```
</div>
:::





# UN Relief Workers Agency (UNRWA)

```{r filter_unrwa, include=FALSE}
data_filtered <- filter(data, organisation == "UNRWA")
# split data into current 72h summary, or full timeseries
# Hi I am commenting this out because it doesn't match the data structure
# This code is written with the indication that a change was introduced to the data analysis pipeline that gets the
# 72 hour summary and puts it into the spreadsheet as date = NA
data_filtered_current <- filter(data_filtered, date == max(date, na.rm=TRUE)) # Temporary fix bc the data from the pipeline isnt' matching atm
data_filtered_timeseries <- filter(data_filtered, !is.na(date))

params <- generate_key_insights(data_filtered_current, strata = "Overall") # TODO iterate over strata to match other chunks
```

## Row

::: {.card fill="false" title="Key insights"}
- Data updated as of **`r params$latest_date`**
<!--- Data from **`r params$cohort_size` participants** reporting over the last 72 hours
commenting out, because there's a bug here somewhere at least -->
- Median change of **`r params$median_change`%** compared to pre-war weight (with a typical range of `r params$lower_change`% to `r params$upper_change`%)
:::

## Row

::: {.card .current_summary_card .lshtm_widget title="Current summary" fill = "false"}
<!-- Can't set ID or data-widget value in this pandoc-card element, so need another nested div... -->
<div class="lshtm_widget_identifier" id="current_summary">
```{r plot-current-summary-unrwa, results="asis"}
#| fig-width: 8
#| fig-asp: 0.4
#| fig-align: center
for(i in strata) {
  # show the first stratum (overall) by default
  visible_class = ifelse(i == strata[1], "visible", "")
  cat(glue::glue("<div class='lshtm_widget_content {visible_class}' id='current_summary_{i}'>"))
  
  print(
    plot_current_summary_stats(
      data = data_filtered_current,
      strata = i
    )
  )
  cat('</div>')
}
```
</div>
Summary of most recent data provided by participants reporting over the last 3 days. Current weight in kilograms (kg) and [BMI (body mass index)](https://www.cdc.gov/bmi/adult-calculator/index.html?), in addition to percent change in weight and BMI from pre-war levels (before October 8th 2023) are shown on the x-axes of the panels. Negative values of percent change indicate weight loss, i.e. '-20%' indicates an average loss of 20% of weight or BMI.
:::

## Row
<!-- Create div for trend over time -->
::: {.card .trend_time_card .lshtm_widget title="Recent trends" fill = "false"}
<!-- Can't set ID or data-widget value in this pandoc-card element, so need another nested div... -->
<div class="lshtm_widget_identifier" id="trend_over_time">
```{r plot-trends-weight-unrwa, results="asis"}
#| fig-width: 8
#| fig-asp: 1.3
#| fig-align: center
for(i in strata) {
  # show the first stratum (overall) by default
  visible_class = ifelse(i == strata[1], "visible", "")
  cat(glue::glue("<div class='lshtm_widget_content {visible_class}' id='trend_over_time_{i}'>"))
  
  print(
   plot_time_series_statistics(
      data = data_filtered_timeseries,
      strata = i
    )
  )
  cat('</div>')
}
```
</div>
Trends over time in absolute values of weight in kilograms (kg) and [BMI (body mass index)](https://www.cdc.gov/bmi/adult-calculator/index.html?) and percent change in weight and BMI from pre-war levels (before October 8th 2023) since the beginning of the project. Solid and dashed lines indicate mean and median values respectively for each demographic stratification. The coloured shaded regions show the boundaries of the interquartile range.
:::

## Row
<!-- Create div for trend over time -->
::: {.card .trend_bmi_card .lshtm_widget title="% Participants by BMI category" fill = "false"}
<!-- Can't set ID or data-widget value in this pandoc-card element, so need another nested div... -->
<div class="lshtm_widget_identifier" id="trends_bmi">
```{r plot-trends-bmi-unrwa, results="asis"}
#| fig-width: 8
#| fig-asp: 1
#| fig-align: center
for(i in strata) {
  # show the first stratum (overall) by default
  visible_class = ifelse(i == strata[1], "visible", "")
  cat(glue::glue("<div class='lshtm_widget_content {visible_class}' id='trends_bmi_{i}'>"))
  
  print(
     plot_bmicategory_proportions_time_series(
     data = data_filtered_timeseries,
     strata = i
    )
  )
  cat('</div>')
}
```
</div>
Trends over time of proportion of staff with BMI in different [WHO categories](https://www.who.int/data/gho/data/themes/topics/topic-details/GHO/body-mass-index): underweight <18.5, normal 18.50 – 24.99, overweight ≥ 25, obese ≥ 30. Calculated as the number of measurements per day that fall in each category, divided by the total number of measurements that day.
:::

## Row

::: {.card fill="false" .lshtm_widget title="Study participation"}
<div class="lshtm_widget_identifier" id="participants_over_time">
```{r plot-participants-over-time-unrwa, results="asis"}
#| fig-width: 7
#| fig-asp: 0.5
#| fig-align: center
for(i in strata) {
  # show the first stratum (overall) by default
  visible_class = ifelse(i == strata[1], "visible", "")
  cat(glue::glue("<div class='lshtm_widget_content {visible_class}' id='participants_over_time_{i}'>"))
  
  print(
    plot_participants_over_time(
      data = data_filtered_timeseries,
      strata = i
    )
  )
  cat('</div>')
}
```
</div>
:::




