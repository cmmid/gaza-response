---
title: Dashboard
format: 
  dashboard:
    scrolling: true
    include-in-header:
      text: |
            <script src="lshtm.js"></script>
    css: "styles.css"
  #html:
  #  page-layout: custom
execute: 
  echo: false
---

<!-- Setup, no output -->

```{r setup, include=FALSE}
## Packages
pacman::p_load(here, 
               purrr, readr, dplyr,
               bslib, bsicons, 
               ggplot2)
## Load all csv data
data <- list.files(here("data"), pattern = "*.csv")
names(data) <- gsub("\\.csv", "", data)
data <- map(data,
            ~ read_csv(here("data", .x)) |> 
              mutate(Group = ifelse(is.na(Group), "Overall", Group)))

## Source plotting scripts
source(here("R", "plot_bmicategory_proportions.R"))
source(here("R", "plot_bmicategory_proportions_time_series.R"))
source(here("R", "plot_current_summary_stats.R"))
source(here("R", "plot_time_series_statistics.R"))

## Set parameters
params <- list(
  # Most recent date
  latest_date = max(data$time_series_table$Date),
  # N
  participants = data$bmicategory_proportions |> 
    filter(Date == max(Date) & Stratification=="Overall") |> 
                 pull(n) |> sum(),
  # Overall median
  median_change = data$current_summary_stats |> 
    filter(Stratification=="Overall" & 
             Variable=="% Weight Change from Prewar Value") |> 
    pull(median) |> round(digits = 1),
  # Stratifications
  strata = unique(data$bmicategory_proportions$Stratification)
  )
```

<!-- Global sidebar -->

# {.sidebar}

<!-- Add data filter
 - todo: change to pandoc format
 - todo: fill options automatically or wrap in function
-->
<div class="lshtm_widget_filter">
  <p><strong>Filter Data</strong></p>
  <div class="filter_content">
  <fieldset>
    <legend>Show data by</legend>
    <label>
      <input type="radio" name="data_filter" value="Overall" checked>
      All
    </label><br>
    <label>
      <input type="radio" name="data_filter" value="sex">
      Sex
    </label><br>
    <label>
      <input type="radio" name="data_filter" value="agegroup">
      Age
    </label><br>
    <label>
      <input type="radio" name="data_filter" value="governorate">
      Location
    </label><br>
    <label>
      <input type="radio" name="data_filter" value="role">
      Role
    </label>
  </fieldset>
</div>
</div>

<!-- Dashboard page 1 -->

# Weight change
::: {.card fill="false" title="Key insights"}
- Data updated as of **`r params$latest_date`**
- Collected data from **`r params$participants` participants**
- Median **`r params$median_change[1]`kg** change compared to pre-war weight
:::

## Row

### Column

<!-- Create div for percentage change baseline
  - Could wrap this in function
  - TODO: some cleaning needed
-->
::: {.card .lshtm_widget title="Change from pre-war baseline"}
<!-- Can't set ID or data-widget value in this pandoc-card element, so need another nested div... -->
<div class="lshtm_widget_identifier" id="percentage_change_baseline">
```{r plot-baseline-weight, results="asis"}
for(i in params$strata) {
  # show the first stratum (overall) by default
  visible_class = ifelse(i == params$strata[1], "visible", "")
  cat(glue::glue("<div class='lshtm_widget_content {visible_class}' id='percentage_change_baseline_{i}'>"))
  
  print(
    plot_current_summary_stats(
      data = data$current_summary_stats,
      strata = i
    )
  )
  cat('</div>')
}
```
</div>
:::

### Column

<!-- Create div for trend over time -->
::: {.card .lshtm_widget title="Trend over time"}
<!-- Can't set ID or data-widget value in this pandoc-card element, so need another nested div... -->
<div class="lshtm_widget_identifier" id="trend_over_time">
```{r plot-trends-weight, results="asis"}
for(i in params$strata) {
  # show the first stratum (overall) by default
  visible_class = ifelse(i == params$strata[1], "visible", "")
  cat(glue::glue("<div class='lshtm_widget_content {visible_class}' id='trend_over_time_{i}'>"))
  
  print(
    plot_time_series_statistics(
      data = data$time_series_table,
      strata = i
    )
  )
  cat('</div>')
}
```
</div>
:::

## Row {height=20%}

::: {.card title="Notes"}

Change in self-reported weight from pre-war baseline.

:::

<!-- Dashboard page 2 -->

# BMI change
::: {.card fill="false" title="Key insights"}
- Data updated as of **`r params$latest_date`**
- Collected data from **`r params$participants` participants**
- Median **`r params$median_change[1]`kg** change compared to pre-war weight
:::

## Row

### Column

<!-- Create div for trend over time -->
::: {.card .lshtm_widget title="Change from pre-war baseline"}
<!-- Can't set ID or data-widget value in this pandoc-card element, so need another nested div... -->
<div class="lshtm_widget_identifier" id="baseline_bmi">
```{r plot-baseline-bmi, results="asis"}
for(i in params$strata) {
  # show the first stratum (overall) by default
  visible_class = ifelse(i == params$strata[1], "visible", "")
  cat(glue::glue("<div class='lshtm_widget_content {visible_class}' id='baseline_bmi_{i}'>"))
  
  print(
    plot_bmicategory_proportions(
      data = data$bmicategory_proportions,
      strata = i
    )
  )
  cat('</div>')
}
```
</div>
:::

### Column

<!-- Create div for trend over time -->
::: {.card .lshtm_widget title="Trend over time"}
<!-- Can't set ID or data-widget value in this pandoc-card element, so need another nested div... -->
<div class="lshtm_widget_identifier" id="trends_bmi">
```{r plot-trends-bmi, results="asis"}
for(i in params$strata) {
  # show the first stratum (overall) by default
  visible_class = ifelse(i == params$strata[1], "visible", "")
  cat(glue::glue("<div class='lshtm_widget_content {visible_class}' id='trends_bmi_{i}'>"))
  
  print(
    plot_bmicategory_proportions_time_series(
      data = data$bmicategory_proportions,
      strata = i
    )
  )
  cat('</div>')
}
```
</div>
:::

## Row {height=20%}

::: {.card title="Notes"}

Proportion of staff with BMI in different WHO categories: underweight <18.5, normal 18.50 – 24.99, overweight ≥ 25, obese ≥ 30.

:::

<!-- Dashboard page 3 -->

# Modelled % change 
::: {.card fill="false" title="Key insights"}
- Data updated as of **`r params$latest_date`**
- Collected data from **`r params$participants` participants**
- Median **`r params$median_change[1]`kg** change compared to pre-war weight
:::

<!-- Create div for trend over time -->
::: {.card .lshtm_widget title="Modelled change in individual weight"}
<!-- Can't set ID or data-widget value in this pandoc-card element, so need another nested div... -->
<div class="lshtm_widget_identifier" id="gam">
```{r plot-gam, results="asis"}
for(i in params$strata) {
  # show the first stratum (overall) by default
  visible_class = ifelse(i == params$strata[1], "visible", "")
  cat(glue::glue("<div class='lshtm_widget_content {visible_class}' id='gam_{i}'>"))
  
  print(
    sprintf("Plot for stratum %s TBC", i)
  )
  cat('</div>')
}
```
</div>
:::

::: {.card title="Notes"}

Modelled changes in self-reported weight.

:::
