---
title: Dashboard
format: dashboard
execute: 
  echo: false
---

```{r setup, include=FALSE}
# Dashboard
pacman::p_load(here, 
               purrr, readr, dplyr,
               bslib, bsicons, 
               ggplot2)

## Load all csv data
data <- list.files(here("data"), pattern = "*.csv")
names(data) <- gsub("\\.csv", "", data)
data <- map(data,
            ~ read_csv(here("data", .x)) |> 
              mutate(Group = ifelse(is.na(Group), "Overall", Group)))
       
## Source plotting scripts
source(here("R", "plot_bmicategory_proportions.R"))
source(here("R", "plot_bmicategory_proportions_time_series.R"))
source(here("R", "plot_current_summary_stats.R"))
source(here("R", "plot_time_series_statistics.R"))

## Set parameters
params <- list(
  # Most recent date
  latest_date = max(data$time_series_table$Date),
  # N
  participants = data$bmicategory_proportions |> 
    filter(date == max(date) & Stratification=="Overall") |> 
                 pull(n) |> sum(),
  # Overall median
  median_change = data$current_summary_stats |> 
    filter(Stratification=="Overall" & 
             Variable=="% Weight Change from Prewar Value") |> 
    pull(median) |> round(digits = 1),
  # Stratifications
  strata = unique(data$bmicategory_proportions$Stratification)
  )
```

# {.sidebar}

::: {.callout-note}

## Latest data

As of **`r params$latest_date`**:

- **`r params$participants`** participants
- Median **`r params$median_change`**kg change from pre-war weight

:::

### 

This project aims to monitor the nutritional status of humanitarian aid staff currently working in Gaza by tracking their weight. The hope of this project is to give a voice to aid workers who are currently based in Gaza, as essentials and humanitarian aid continues to be blocked from entering. 

Participation is entirely voluntary. The project is implemented by SCI with the support of the London School of Hygiene and Tropical Medicine (LSHTM). [Learn more](./protocol)

# Weight change

## Row

### Column

::: {.panel-tabset title = "Change in weight, kg"}

```{r plot-absolute, results="asis"}
for(i in params$strata) {
  cat(glue::glue("### {i} \n\n"))
  cat("\n \n")
  print(
    plot_current_summary_stats(data$current_summary_stats, 
                               strata = i)
  )
  cat(' \n \n')
}
```

:::

### Column

::: {.panel-tabset}

```{r plot-trends, results="asis"}
for(i in params$strata) {
  cat(glue::glue("### {i} \n\n"))
  cat("\n \n")
  
  print(
    plot_time_series_statistics(data_time_series, strata = i)
  )
  cat(' \n \n')
}
```

:::

## Row {height=20%}

::: {.card title="Notes"}

Change in self-reported weight from pre-war baseline.

:::

# Modelled % change 

## Row

::: {.panel-tabset title = "Modelled change in individual weight"}

```{r plot-gam, results="asis"}
# for(i  in params$strata) {
#   cat(glue::glue("### {i} \n\n"))
#   cat("\n \n")
#   
#   print(
#     plot()
#   )
#   cat(' \n \n')
# }
```

:::

## Row

::: {.card title="Notes"}

Trends in changes in self-reported weight.

:::

# BMI

## Row

::: {.panel-tabset title = "BMI categories"}

```{r plot-bmi, results="asis"}
for(i in params$strata) {
  cat(glue::glue("### {i} \n\n"))
  cat("\n \n")
  
  print(
    plot_bmi(bmi, stratification = i, date = params$latest_date)
  )
  cat(' \n \n')
}
```

:::

## Row {.flow}

::: {.card title="Notes"}

Proportion of staff with BMI in different WHO categories: underweight <18.5, normal 18.50 – 24.99, overweight ≥ 25, obese ≥ 30.

:::






